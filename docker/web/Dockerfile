# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Stage 1) Python builder: Reflexê°€ Next(.web) ìƒì„±
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FROM python:3.11-slim AS reflex-builder
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

WORKDIR /src

# bun ì„¤ì¹˜ìš© unzip (+ curl/ca-certificates), ë¹Œë“œ ë„êµ¬
RUN apt-get update && apt-get install -y --no-install-recommends \
      curl unzip ca-certificates build-essential git \
 && rm -rf /var/lib/apt/lists/*

# ì˜ì¡´ì„± ì„¤ì¹˜
COPY requirements.txt /src/requirements.txt
RUN pip install --no-cache-dir -r /src/requirements.txt reflex

# ë¹Œë“œ ì „ìš© ì„ì‹œ DB_URL (import ì‹œ ì—ëŸ¬ ë°©ì§€)
ENV DB_URL=sqlite://

# ì•± ì†ŒìŠ¤ ë³µì‚¬ í›„ Reflex export (Next ê¸°ë°˜ .web ìƒì„±)
COPY . /src
RUN reflex export

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Stage 2) Node builder: .webì„ Next í”„ë¡œë•ì…˜ ë¹Œë“œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FROM node:20-slim AS next-builder
WORKDIR /app

# Reflexê°€ ìƒì„±í•œ .web ë³µì‚¬
COPY --from=reflex-builder /src/.web /app

# ğŸ”§ lock íŒŒì¼ì´ ìˆìœ¼ë©´ npm ci, ì—†ìœ¼ë©´ npm installë¡œ ì ê¸ˆ ìƒì„± í›„ ë¹Œë“œ
RUN if [ -f package-lock.json ]; then \
      npm ci --no-audit --no-fund; \
    else \
      npm install --no-audit --no-fund; \
    fi \
 && npm run build

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Stage 3) Runtime: Next ì„œë²„ë§Œ ì‹¤í–‰ (í”„ëŸ°íŠ¸ì—”ë“œ ì „ìš©)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FROM node:20-slim AS web-runtime
ENV NODE_ENV=production \
    NEXT_TELEMETRY_DISABLED=1
WORKDIR /web

# ëŸ°íƒ€ì„ì— í•„ìš”í•œ ì‚°ì¶œë¬¼/ë©”íƒ€ë§Œ ë³µì‚¬
COPY --from=next-builder /app/.next /web/.next
COPY --from=next-builder /app/public /web/public
COPY --from=next-builder /app/package.json /web/package.json
COPY --from=next-builder /app/package-lock.json /web/package-lock.json

# prod ì˜ì¡´ì„±ë§Œ ì„¤ì¹˜ (dev ì œì™¸)
RUN npm ci --omit=dev

# ë³´ì•ˆ: ë¹„ë£¨íŠ¸ ì‹¤í–‰
RUN chown -R node:node /web
USER node

EXPOSE 3000
# Next ê¸°ë³¸ start ìŠ¤í¬ë¦½íŠ¸(-p 3000). Caddyê°€ 3000ìœ¼ë¡œ í”„ë¡ì‹œ
CMD ["npm", "run", "start", "--", "-p", "3000"]